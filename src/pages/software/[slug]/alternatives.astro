---
/**
 * Alternatives page - Shows competing products for each software
 * URL: /software/{slug}/alternatives/
 */
import BaseLayout from '../../../layouts/BaseLayout.astro';
import AggregateRating from '../../../components/AggregateRating.astro';
import { getCollection } from 'astro:content';
import aggregatedReviews from '../../../../data/reviews/aggregated-reviews.json';

export async function getStaticPaths() {
  const software = await getCollection('software');
  return software.map((entry) => ({
    params: { slug: entry.data.slug },
    props: {
      software: entry.data,
      allSoftware: software.map((s) => s.data),
    },
  }));
}

interface SoftwareData {
  name: string;
  slug: string;
  website: string;
  logo: string;
  description: string;
  pricing: {
    model: string;
    starting_price: number | null;
    currency: string;
    has_free_trial: boolean;
  };
  ketamine_features: Record<string, boolean>;
  ideal_for: string;
}

interface Props {
  software: SoftwareData;
  allSoftware: SoftwareData[];
}

const { software, allSoftware } = Astro.props;

// Get alternatives (all other software, sorted by ketamine feature count)
const alternatives = allSoftware
  .filter((s) => s.slug !== software.slug)
  .map((s) => ({
    ...s,
    featureCount: Object.values(s.ketamine_features).filter(Boolean).length,
    reviewData: aggregatedReviews[s.slug as keyof typeof aggregatedReviews] || {
      aggregateScore: null,
      totalCount: 0,
      sources: [],
    },
  }))
  .sort((a, b) => b.featureCount - a.featureCount);

const currentFeatureCount = Object.values(software.ketamine_features).filter(Boolean).length;

function formatPrice(price: number | null, currency: string): string {
  if (price === null) return 'Contact for pricing';
  if (price === 0) return 'Free tier';
  const symbol = currency === 'CAD' ? 'CA$' : '$';
  return `${symbol}${price}/mo`;
}

const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'ItemList',
  name: `${software.name} Alternatives for Ketamine Clinics`,
  description: `Compare ${software.name} with ${alternatives.length} alternative EHR and practice management solutions for ketamine clinics.`,
  numberOfItems: alternatives.length,
  itemListElement: alternatives.map((alt, index) => ({
    '@type': 'ListItem',
    position: index + 1,
    item: {
      '@type': 'SoftwareApplication',
      name: alt.name,
      url: `https://ketaminesoftware.com/software/${alt.slug}/`,
    },
  })),
};
---

<BaseLayout
  title={`${software.name} Alternatives 2026 - Top ${alternatives.length} Competitors Compared`}
  description={`Looking for ${software.name} alternatives? Compare ${alternatives.length} EHR and practice management solutions for mental health practices with features, pricing, and reviews.`}
  jsonLd={jsonLd}
>
  <!-- Breadcrumb -->
  <nav class="border-b border-slate-200 bg-slate-50 px-4 py-3 sm:px-6 lg:px-8">
    <div class="mx-auto max-w-7xl">
      <ol class="flex items-center gap-2 text-sm">
        <li>
          <a href="/" class="text-slate-500 hover:text-slate-700">Home</a>
        </li>
        <li class="text-slate-400">/</li>
        <li>
          <a href="/software/" class="text-slate-500 hover:text-slate-700">Software</a>
        </li>
        <li class="text-slate-400">/</li>
        <li>
          <a href={`/software/${software.slug}/`} class="text-slate-500 hover:text-slate-700">{software.name}</a>
        </li>
        <li class="text-slate-400">/</li>
        <li class="text-slate-900">Alternatives</li>
      </ol>
    </div>
  </nav>

  <!-- Header -->
  <section class="px-4 py-12 sm:px-6 lg:px-8">
    <div class="mx-auto max-w-4xl text-center">
      <h1 class="text-3xl font-bold tracking-tight text-slate-900 sm:text-4xl">
        {software.name} Alternatives
      </h1>
      <p class="mt-4 text-lg text-slate-600">
        Compare {alternatives.length} alternative EHR and practice management solutions for ketamine clinics.
        {software.name} has {currentFeatureCount} of 7 ketamine-specific features.
      </p>
    </div>
  </section>

  <!-- Alternatives List -->
  <section class="bg-slate-50 px-4 py-12 sm:px-6 lg:px-8">
    <div class="mx-auto max-w-5xl">
      <div class="space-y-4">
        {alternatives.map((alt, index) => (
          <div class="rounded-xl border border-slate-200 bg-white p-6">
            <div class="flex flex-col gap-6 md:flex-row md:items-start md:justify-between">
              <div class="flex items-start gap-4">
                <div class="flex h-14 w-14 shrink-0 items-center justify-center rounded-lg bg-slate-100">
                  <img
                    src={alt.logo}
                    alt={`${alt.name} logo`}
                    class="h-10 w-10 object-contain"
                    onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                  />
                  <span class="hidden h-10 w-10 items-center justify-center text-lg font-bold text-slate-400">
                    {alt.name.charAt(0)}
                  </span>
                </div>
                <div class="flex-1">
                  <div class="flex items-center gap-2">
                    <span class="text-sm font-medium text-slate-500">#{index + 1}</span>
                    <h2 class="text-xl font-semibold text-slate-900">{alt.name}</h2>
                    {alt.featureCount > currentFeatureCount && (
                      <span class="rounded-full bg-teal-100 px-2 py-0.5 text-xs font-medium text-teal-700">
                        +{alt.featureCount - currentFeatureCount} features
                      </span>
                    )}
                  </div>
                  <p class="mt-1 text-sm text-slate-600 line-clamp-2">{alt.description}</p>

                  <div class="mt-3">
                    <AggregateRating
                      score={alt.reviewData.aggregateScore}
                      totalCount={alt.reviewData.totalCount}
                      sources={alt.reviewData.sources}
                      size="sm"
                      showSources={false}
                    />
                  </div>
                </div>
              </div>

              <div class="flex shrink-0 flex-col items-end gap-3 md:text-right">
                <div>
                  <p class="text-lg font-semibold text-slate-900">
                    {formatPrice(alt.pricing.starting_price, alt.pricing.currency)}
                  </p>
                  {alt.pricing.has_free_trial && (
                    <span class="text-xs text-teal-600">Free trial</span>
                  )}
                </div>
                <div class="flex items-center gap-2 text-sm">
                  <span class="rounded bg-teal-50 px-2 py-1 text-teal-700">
                    {alt.featureCount}/7 ketamine features
                  </span>
                </div>
                <div class="flex gap-2">
                  <a
                    href={`/software/${alt.slug}/`}
                    class="rounded-lg border border-slate-200 px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50"
                  >
                    View Details
                  </a>
                  <a
                    href={`/compare/${software.slug}-vs-${alt.slug}/`}
                    class="rounded-lg bg-teal-600 px-3 py-2 text-sm font-medium text-white hover:bg-teal-700"
                  >
                    Compare
                  </a>
                </div>
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Back to Main Review -->
  <section class="border-t border-slate-200 px-4 py-8 sm:px-6 lg:px-8">
    <div class="mx-auto max-w-3xl text-center">
      <a
        href={`/software/${software.slug}/`}
        class="inline-flex items-center text-teal-600 hover:text-teal-700"
      >
        <svg class="mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
        </svg>
        Back to {software.name} Review
      </a>
    </div>
  </section>
</BaseLayout>
