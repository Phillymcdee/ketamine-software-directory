---
/**
 * Pricing page - Detailed pricing breakdown with comparison
 * URL: /software/{slug}/pricing/
 */
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const software = await getCollection('software');
  return software.map((entry) => ({
    params: { slug: entry.data.slug },
    props: {
      software: entry.data,
      allSoftware: software.map((s) => s.data),
    },
  }));
}

interface SoftwareData {
  name: string;
  slug: string;
  website: string;
  logo: string;
  description: string;
  pricing: {
    model: string;
    starting_price: number | null;
    currency: string;
    has_free_trial: boolean;
    billing_cycle: string;
    notes: string;
  };
  ketamine_features: Record<string, boolean>;
}

interface Props {
  software: SoftwareData;
  allSoftware: SoftwareData[];
}

const { software, allSoftware } = Astro.props;

// Get comparable software sorted by price
const comparable = allSoftware
  .filter((s) => s.slug !== software.slug)
  .map((s) => ({
    ...s,
    featureCount: Object.values(s.ketamine_features).filter(Boolean).length,
  }))
  .sort((a, b) => {
    if (a.pricing.starting_price === null) return 1;
    if (b.pricing.starting_price === null) return -1;
    return (a.pricing.starting_price || 0) - (b.pricing.starting_price || 0);
  });

const currentFeatureCount = Object.values(software.ketamine_features).filter(Boolean).length;

function formatPrice(price: number | null, currency: string, showFull = false): string {
  if (price === null) return 'Contact for pricing';
  if (price === 0) return 'Free tier available';
  const symbol = currency === 'CAD' ? 'CA$' : '$';
  return showFull ? `${symbol}${price} per month` : `${symbol}${price}/mo`;
}

function getPricingModel(model: string): string {
  const models: Record<string, string> = {
    per_clinician: 'Per Clinician',
    flat: 'Flat Rate',
    tiered: 'Tiered Pricing',
    contact: 'Custom Pricing',
  };
  return models[model] || model;
}

const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'Product',
  name: software.name,
  description: `${software.name} pricing for ketamine clinics. ${software.description}`,
  offers: software.pricing.starting_price !== null
    ? {
        '@type': 'Offer',
        price: software.pricing.starting_price,
        priceCurrency: software.pricing.currency,
        priceValidUntil: new Date(new Date().setFullYear(new Date().getFullYear() + 1)).toISOString().split('T')[0],
      }
    : undefined,
};
---

<BaseLayout
  title={`${software.name} Pricing 2026 - Plans, Cost & Free Trial`}
  description={`${software.name} pricing starts at ${formatPrice(software.pricing.starting_price, software.pricing.currency)}. Compare all plans, see what's included, and check free trial availability. Full pricing breakdown for mental health practices.`}
  jsonLd={jsonLd}
>
  <!-- Breadcrumb -->
  <nav class="border-b border-slate-200 bg-slate-50 px-4 py-3 sm:px-6 lg:px-8">
    <div class="mx-auto max-w-7xl">
      <ol class="flex items-center gap-2 text-sm">
        <li>
          <a href="/" class="text-slate-500 hover:text-slate-700">Home</a>
        </li>
        <li class="text-slate-400">/</li>
        <li>
          <a href="/software/" class="text-slate-500 hover:text-slate-700">Software</a>
        </li>
        <li class="text-slate-400">/</li>
        <li>
          <a href={`/software/${software.slug}/`} class="text-slate-500 hover:text-slate-700">{software.name}</a>
        </li>
        <li class="text-slate-400">/</li>
        <li class="text-slate-900">Pricing</li>
      </ol>
    </div>
  </nav>

  <!-- Header -->
  <section class="px-4 py-12 sm:px-6 lg:px-8">
    <div class="mx-auto max-w-4xl">
      <div class="flex flex-col items-center gap-6 text-center md:flex-row md:text-left">
        <div class="flex h-20 w-20 shrink-0 items-center justify-center rounded-xl bg-slate-100">
          <img
            src={software.logo}
            alt={`${software.name} logo`}
            class="h-14 w-14 object-contain"
            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
          />
          <span class="hidden h-14 w-14 items-center justify-center text-2xl font-bold text-slate-400">
            {software.name.charAt(0)}
          </span>
        </div>
        <div>
          <h1 class="text-3xl font-bold tracking-tight text-slate-900 sm:text-4xl">
            {software.name} Pricing
          </h1>
          <p class="mt-2 text-lg text-slate-600">
            Pricing details and cost comparison for ketamine clinics
          </p>
        </div>
      </div>
    </div>
  </section>

  <!-- Main Pricing Card -->
  <section class="bg-teal-50 px-4 py-12 sm:px-6 lg:px-8">
    <div class="mx-auto max-w-2xl">
      <div class="rounded-2xl border-2 border-teal-200 bg-white p-8 text-center shadow-sm">
        <p class="text-sm font-medium uppercase tracking-wide text-teal-600">Starting at</p>
        <p class="mt-2 text-5xl font-bold text-slate-900">
          {formatPrice(software.pricing.starting_price, software.pricing.currency)}
        </p>
        <p class="mt-2 text-slate-500">{getPricingModel(software.pricing.model)}</p>

        <div class="mt-6 space-y-3">
          <div class="flex items-center justify-center gap-2">
            {software.pricing.has_free_trial ? (
              <>
                <svg class="h-5 w-5 text-teal-500" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" />
                </svg>
                <span class="text-teal-700">Free trial available</span>
              </>
            ) : (
              <>
                <svg class="h-5 w-5 text-slate-400" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" />
                </svg>
                <span class="text-slate-500">No free trial</span>
              </>
            )}
          </div>
          <p class="text-sm text-slate-500">Billing: {software.pricing.billing_cycle}</p>
        </div>

        {software.pricing.notes && (
          <div class="mt-6 rounded-lg bg-slate-50 p-4">
            <p class="text-sm text-slate-600">{software.pricing.notes}</p>
          </div>
        )}

        <div class="mt-8">
          <a
            href={software.website}
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center justify-center rounded-lg bg-teal-600 px-6 py-3 text-base font-medium text-white hover:bg-teal-700"
          >
            Get Pricing Details
            <svg class="ml-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 0 0 3 8.25v10.5A2.25 2.25 0 0 0 5.25 21h10.5A2.25 2.25 0 0 0 18 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" />
            </svg>
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Pricing Comparison Table -->
  <section class="px-4 py-12 sm:px-6 lg:px-8">
    <div class="mx-auto max-w-5xl">
      <h2 class="text-2xl font-bold text-slate-900">Pricing Comparison</h2>
      <p class="mt-2 text-slate-600">
        Compare {software.name} pricing with other ketamine clinic software options
      </p>

      <div class="mt-8 overflow-x-auto">
        <table class="w-full border-collapse">
          <thead>
            <tr class="border-b border-slate-200">
              <th class="py-3 pr-4 text-left text-sm font-semibold text-slate-900">Software</th>
              <th class="px-4 py-3 text-left text-sm font-semibold text-slate-900">Starting Price</th>
              <th class="px-4 py-3 text-left text-sm font-semibold text-slate-900">Model</th>
              <th class="px-4 py-3 text-center text-sm font-semibold text-slate-900">Free Trial</th>
              <th class="px-4 py-3 text-center text-sm font-semibold text-slate-900">Ketamine Features</th>
              <th class="pl-4 py-3 text-right text-sm font-semibold text-slate-900"></th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100">
            <!-- Current software (highlighted) -->
            <tr class="bg-teal-50">
              <td class="py-4 pr-4">
                <div class="flex items-center gap-3">
                  <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-white">
                    <img
                      src={software.logo}
                      alt={`${software.name} logo`}
                      class="h-7 w-7 object-contain"
                      onerror="this.style.display='none';"
                    />
                  </div>
                  <span class="font-medium text-slate-900">{software.name}</span>
                </div>
              </td>
              <td class="px-4 py-4 font-semibold text-teal-700">
                {formatPrice(software.pricing.starting_price, software.pricing.currency)}
              </td>
              <td class="px-4 py-4 text-sm text-slate-600">{getPricingModel(software.pricing.model)}</td>
              <td class="px-4 py-4 text-center">
                {software.pricing.has_free_trial ? (
                  <span class="text-teal-600">Yes</span>
                ) : (
                  <span class="text-slate-400">No</span>
                )}
              </td>
              <td class="px-4 py-4 text-center">
                <span class="rounded-full bg-teal-100 px-2 py-1 text-sm font-medium text-teal-700">
                  {currentFeatureCount}/7
                </span>
              </td>
              <td class="py-4 pl-4 text-right text-sm text-teal-600">Current</td>
            </tr>

            <!-- Other software -->
            {comparable.map((comp) => (
              <tr class="hover:bg-slate-50">
                <td class="py-4 pr-4">
                  <div class="flex items-center gap-3">
                    <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-slate-100">
                      <img
                        src={comp.logo}
                        alt={`${comp.name} logo`}
                        class="h-7 w-7 object-contain"
                        onerror="this.style.display='none';"
                      />
                    </div>
                    <span class="text-slate-900">{comp.name}</span>
                  </div>
                </td>
                <td class="px-4 py-4 text-slate-900">
                  {formatPrice(comp.pricing.starting_price, comp.pricing.currency)}
                </td>
                <td class="px-4 py-4 text-sm text-slate-600">{getPricingModel(comp.pricing.model)}</td>
                <td class="px-4 py-4 text-center">
                  {comp.pricing.has_free_trial ? (
                    <span class="text-teal-600">Yes</span>
                  ) : (
                    <span class="text-slate-400">No</span>
                  )}
                </td>
                <td class="px-4 py-4 text-center">
                  <span class="text-sm text-slate-600">{comp.featureCount}/7</span>
                </td>
                <td class="py-4 pl-4 text-right">
                  <a
                    href={`/software/${comp.slug}/pricing/`}
                    class="text-sm text-teal-600 hover:text-teal-700"
                  >
                    View
                  </a>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Back to Main Review -->
  <section class="border-t border-slate-200 px-4 py-8 sm:px-6 lg:px-8">
    <div class="mx-auto max-w-3xl text-center">
      <a
        href={`/software/${software.slug}/`}
        class="inline-flex items-center text-teal-600 hover:text-teal-700"
      >
        <svg class="mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
        </svg>
        Back to {software.name} Review
      </a>
    </div>
  </section>
</BaseLayout>
