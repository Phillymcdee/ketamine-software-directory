---
import BaseLayout from '../../layouts/BaseLayout.astro';
import AggregateRating from '../../components/AggregateRating.astro';
import ReviewBadge from '../../components/ReviewBadge.astro';
import { getCollection } from 'astro:content';
import aggregatedReviews from '../../../data/reviews/aggregated-reviews.json';

export async function getStaticPaths() {
  const software = await getCollection('software');
  return software.map((entry) => ({
    params: { slug: entry.data.slug },
    props: { software: entry.data },
  }));
}

interface Props {
  software: {
    name: string;
    slug: string;
    website: string;
    logo: string;
    description: string;
    pricing: {
      model: string;
      starting_price: number | null;
      currency: string;
      has_free_trial: boolean;
      billing_cycle: string;
      notes: string;
    };
    ketamine_features: Record<string, boolean>;
    general_features: Array<{ category: string; feature: string; available: boolean }>;
    integrations: string[];
    pros: string[];
    cons: string[];
    ideal_for: string;
    last_verified: string;
    data_source: string;
  };
}

const { software } = Astro.props;

// Get review data for this software
const reviewData = aggregatedReviews[software.slug as keyof typeof aggregatedReviews] || {
  aggregateScore: null,
  totalCount: 0,
  sources: [],
};

function formatPrice(price: number | null, currency: string): string {
  if (price === null) return 'Contact for pricing';
  if (price === 0) return 'Free tier available';
  const symbol = currency === 'CAD' ? 'CA$' : '$';
  return `From ${symbol}${price}/mo`;
}

const ketamineFeatureLabels: Record<string, string> = {
  iv_protocols: 'IV Ketamine Protocols',
  im_protocols: 'IM Ketamine Protocols',
  outcome_tracking: 'Outcome Tracking',
  spravato_workflows: 'SPRAVATO® Workflows',
  patient_rating_scales: 'Patient Rating Scales',
  ketamine_consent_forms: 'Ketamine Consent Forms',
  treatment_series_tracking: 'Treatment Series Tracking',
};

const ketamineFeatureCount = Object.values(software.ketamine_features).filter(Boolean).length;
const isKetamineSpecific =
  software.ketamine_features.iv_protocols ||
  software.ketamine_features.im_protocols ||
  software.ketamine_features.ketamine_consent_forms;

// Group general features by category
const featuresByCategory = software.general_features.reduce(
  (acc, feature) => {
    if (!acc[feature.category]) {
      acc[feature.category] = [];
    }
    acc[feature.category].push(feature);
    return acc;
  },
  {} as Record<string, typeof software.general_features>
);

const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'SoftwareApplication',
  name: software.name,
  description: software.description,
  applicationCategory: 'HealthApplication',
  operatingSystem: 'Web',
  url: software.website,
  offers: software.pricing.starting_price !== null
    ? {
        '@type': 'Offer',
        price: software.pricing.starting_price,
        priceCurrency: software.pricing.currency,
        priceSpecification: {
          '@type': 'UnitPriceSpecification',
          price: software.pricing.starting_price,
          priceCurrency: software.pricing.currency,
          unitText: software.pricing.model === 'per_clinician' ? 'per clinician per month' : 'per month',
        },
      }
    : undefined,
  aggregateRating: reviewData.aggregateScore !== null
    ? {
        '@type': 'AggregateRating',
        ratingValue: reviewData.aggregateScore,
        bestRating: 5,
        worstRating: 1,
        ratingCount: reviewData.totalCount,
      }
    : undefined,
};
---

<BaseLayout
  title={`${software.name} Review | Ketamine Clinic Software`}
  description={`${software.name} review for ketamine clinics. ${software.description} Pricing, features, pros and cons.`}
  jsonLd={jsonLd}
>
  <!-- Breadcrumb -->
  <nav class="border-b border-slate-200 bg-slate-50 px-4 py-3 sm:px-6 lg:px-8">
    <div class="mx-auto max-w-7xl">
      <ol class="flex items-center gap-2 text-sm">
        <li>
          <a href="/" class="text-slate-500 hover:text-slate-700">Home</a>
        </li>
        <li class="text-slate-400">/</li>
        <li>
          <a href="/software/" class="text-slate-500 hover:text-slate-700">Software</a>
        </li>
        <li class="text-slate-400">/</li>
        <li class="text-slate-900">{software.name}</li>
      </ol>
    </div>
  </nav>

  <!-- Header -->
  <section class="px-4 py-12 sm:px-6 lg:px-8">
    <div class="mx-auto max-w-7xl">
      <div class="flex flex-col gap-8 lg:flex-row lg:items-start lg:justify-between">
        <!-- Software Info -->
        <div class="flex-1">
          <div class="flex items-start gap-6">
            <div class="flex h-20 w-20 shrink-0 items-center justify-center rounded-xl bg-slate-100">
              <img
                src={software.logo}
                alt={`${software.name} logo`}
                class="h-14 w-14 object-contain"
                onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
              />
              <span class="hidden h-14 w-14 items-center justify-center text-2xl font-bold text-slate-400">
                {software.name.charAt(0)}
              </span>
            </div>
            <div>
              <div class="flex items-center gap-3">
                <h1 class="text-3xl font-bold text-slate-900">{software.name}</h1>
                {isKetamineSpecific && (
                  <span class="rounded-full bg-teal-100 px-3 py-1 text-sm font-medium text-teal-700">
                    Ketamine-Specific
                  </span>
                )}
              </div>
              <p class="mt-2 text-lg text-slate-600">{software.description}</p>

              {/* Aggregate Rating */}
              <div class="mt-4">
                <AggregateRating
                  score={reviewData.aggregateScore}
                  totalCount={reviewData.totalCount}
                  sources={reviewData.sources}
                  size="md"
                  showSources={false}
                />
              </div>
            </div>
          </div>
        </div>

        <!-- Pricing Card -->
        <div class="w-full shrink-0 rounded-xl border border-slate-200 bg-white p-6 shadow-sm lg:w-80">
          <div class="text-center">
            <p class="text-sm text-slate-500">Starting at</p>
            <p class="mt-1 text-3xl font-bold text-slate-900">
              {formatPrice(software.pricing.starting_price, software.pricing.currency)}
            </p>
            <p class="text-sm text-slate-500">
              {software.pricing.model === 'per_clinician' && 'per clinician'}
              {software.pricing.model === 'flat' && 'flat rate'}
            </p>
          </div>

          {software.pricing.has_free_trial && (
            <div class="mt-4 rounded-lg bg-teal-50 p-3 text-center">
              <span class="text-sm font-medium text-teal-700">Free Trial Available</span>
            </div>
          )}

          <div class="mt-6 space-y-3">
            <a
              href={software.website}
              target="_blank"
              rel="noopener noreferrer"
              class="flex w-full items-center justify-center rounded-lg bg-teal-600 px-4 py-3 text-sm font-medium text-white hover:bg-teal-700"
            >
              Visit Website
              <svg class="ml-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 0 0 3 8.25v10.5A2.25 2.25 0 0 0 5.25 21h10.5A2.25 2.25 0 0 0 18 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" />
              </svg>
            </a>
          </div>

          <p class="mt-4 text-xs text-slate-500">{software.pricing.notes}</p>

          {/* Review Badges */}
          {reviewData.sources.length > 0 && (
            <div class="mt-6 border-t border-slate-200 pt-4">
              <p class="mb-3 text-xs font-medium uppercase tracking-wide text-slate-500">Reviews</p>
              <div class="flex flex-col gap-2">
                {reviewData.sources.map((source) => (
                  <ReviewBadge
                    source={source.source as 'g2' | 'capterra'}
                    score={source.score}
                    count={source.count}
                    url={source.url}
                  />
                ))}
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  </section>

  <!-- Ketamine Features -->
  <section class="border-t border-slate-200 bg-teal-50 px-4 py-12 sm:px-6 lg:px-8">
    <div class="mx-auto max-w-7xl">
      <h2 class="text-2xl font-bold text-slate-900">Ketamine-Specific Features</h2>
      <p class="mt-2 text-slate-600">
        {software.name} has {ketamineFeatureCount} of 7 ketamine-specific features
      </p>

      <div class="mt-8 grid gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
        {Object.entries(ketamineFeatureLabels).map(([key, label]) => {
          const hasFeature = software.ketamine_features[key];
          return (
            <div
              class:list={[
                'flex items-center gap-3 rounded-lg border p-4',
                hasFeature ? 'border-teal-200 bg-white' : 'border-slate-200 bg-slate-50',
              ]}
            >
              {hasFeature ? (
                <div class="flex h-8 w-8 shrink-0 items-center justify-center rounded-full bg-teal-100">
                  <svg class="h-5 w-5 text-teal-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
                  </svg>
                </div>
              ) : (
                <div class="flex h-8 w-8 shrink-0 items-center justify-center rounded-full bg-slate-200">
                  <svg class="h-5 w-5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                  </svg>
                </div>
              )}
              <span class:list={['text-sm font-medium', hasFeature ? 'text-slate-900' : 'text-slate-500']}>
                {label}
              </span>
            </div>
          );
        })}
      </div>
    </div>
  </section>

  <!-- General Features -->
  <section class="px-4 py-12 sm:px-6 lg:px-8">
    <div class="mx-auto max-w-7xl">
      <h2 class="text-2xl font-bold text-slate-900">Features</h2>

      <div class="mt-8 grid gap-8 md:grid-cols-2 lg:grid-cols-3">
        {Object.entries(featuresByCategory).map(([category, features]) => (
          <div>
            <h3 class="font-semibold text-slate-900">{category}</h3>
            <ul class="mt-4 space-y-2">
              {features.map((feature) => (
                <li class="flex items-start gap-2">
                  {feature.available ? (
                    <svg class="mt-0.5 h-5 w-5 shrink-0 text-teal-500" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
                    </svg>
                  ) : (
                    <svg class="mt-0.5 h-5 w-5 shrink-0 text-slate-300" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                    </svg>
                  )}
                  <span class:list={['text-sm', feature.available ? 'text-slate-700' : 'text-slate-400']}>
                    {feature.feature}
                  </span>
                </li>
              ))}
            </ul>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Pros & Cons -->
  <section class="border-t border-slate-200 bg-slate-50 px-4 py-12 sm:px-6 lg:px-8">
    <div class="mx-auto max-w-7xl">
      <h2 class="text-2xl font-bold text-slate-900">Pros & Cons</h2>

      <div class="mt-8 grid gap-8 md:grid-cols-2">
        <!-- Pros -->
        <div class="rounded-xl border border-teal-200 bg-white p-6">
          <h3 class="flex items-center gap-2 text-lg font-semibold text-teal-700">
            <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" />
            </svg>
            Pros
          </h3>
          <ul class="mt-4 space-y-3">
            {software.pros.map((pro) => (
              <li class="flex items-start gap-2 text-sm text-slate-700">
                <span class="mt-1 h-1.5 w-1.5 shrink-0 rounded-full bg-teal-500"></span>
                {pro}
              </li>
            ))}
          </ul>
        </div>

        <!-- Cons -->
        <div class="rounded-xl border border-amber-200 bg-white p-6">
          <h3 class="flex items-center gap-2 text-lg font-semibold text-amber-700">
            <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z" />
            </svg>
            Cons
          </h3>
          <ul class="mt-4 space-y-3">
            {software.cons.map((con) => (
              <li class="flex items-start gap-2 text-sm text-slate-700">
                <span class="mt-1 h-1.5 w-1.5 shrink-0 rounded-full bg-amber-500"></span>
                {con}
              </li>
            ))}
          </ul>
        </div>
      </div>
    </div>
  </section>

  <!-- Ideal For & Integrations -->
  <section class="px-4 py-12 sm:px-6 lg:px-8">
    <div class="mx-auto max-w-7xl">
      <div class="grid gap-8 md:grid-cols-2">
        <!-- Ideal For -->
        <div>
          <h2 class="text-xl font-bold text-slate-900">Ideal For</h2>
          <p class="mt-4 text-slate-600">{software.ideal_for}</p>
        </div>

        <!-- Integrations -->
        <div>
          <h2 class="text-xl font-bold text-slate-900">Integrations</h2>
          <div class="mt-4 flex flex-wrap gap-2">
            {software.integrations.map((integration) => (
              <span class="rounded-full bg-slate-100 px-3 py-1 text-sm text-slate-700">
                {integration}
              </span>
            ))}
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer Meta -->
  <section class="border-t border-slate-200 bg-slate-50 px-4 py-6 sm:px-6 lg:px-8">
    <div class="mx-auto max-w-7xl">
      <p class="text-sm text-slate-500">
        Last verified: {software.last_verified} · Data sources: {software.data_source}
      </p>
    </div>
  </section>
</BaseLayout>
